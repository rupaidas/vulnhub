# Neo4j Shell Server `setSessionVariable` Deserialization (CVE-2021-34371)

Neo4j é um sistema de gerenciamento de banco de dados gráfico desenvolvido pela Neo4j, Inc.

Neo4j até 3.4.18 (com o servidor shell habilitado) expõe um serviço RMI que desserializa arbitrariamente objetos Java, por exemplo, por meio de setSessionVariable. Um invasor pode abusar disso para execução remota de código porque existem dependências com cadeias de gadgets exploráveis.

O Neo4j Shell é substituído pelo Cyber Shell após o Neo4j 3.5.

Referências:

- https://www.exploit-db.com/exploits/50170
- https://github.com/mozilla/rhino/issues/520

## Ambiente vulnerável

Se estiver usando Linux ou OSX, você pode executar o seguinte comando para iniciar um Neo4j 3.4.18:

```
TARGET_IP=<your-ip> docker-compose up -d
```

O ambiente `TARGET_IP` é uma configuração para descrever o hostname do Neo4j.

Se você estiver usando o Windows, atualize o conteúdo de `docker-compose.yml` e modifique o ambiente manualmente.

Uma vez que o serviço é iniciado, visite `http://your-ip:7474` para ver a página de gerenciamento web, mas o que precisamos atacar é a porta 1337, que é a porta Neo4j Shell e usa o protocolo RMI para se comunicar.

## Explorando

Enviando solicitação RMI através do [Rhino Gadget](rhino_gadget/):

![](1.png)

`touch /tmp/success5` foi executado com sucesso:

![](2.png)
