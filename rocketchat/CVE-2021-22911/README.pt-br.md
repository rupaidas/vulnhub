# Rocket Chat Pre-Auth Blind NoSQL Injection (CVE-2021-22911)

Rocket.chat é uma plataforma de bate-papo de equipe de código aberto.

No Rocket Chat de 3.12.1 a 3.13.2, o método `getPasswordPolicy` é vulnerável a ataques de injeção NoSQL e não requer autenticação/autorização. Ele pode ser usado para assumir contas de usuários normais vazando tokens de redefinição de senha.

Referências:

- https://blog.sonarsource.com/nosql-injections-in-rocket-chat
- https://www.exploit-db.com/exploits/50108
- https://github.com/CsEnox/CVE-2021-22911
- https://paper.seebug.org/1652/

## Aplicativo Vulnerável

Executando o seguinte comando para iniciar um Rocket Chat 3.12.1:

```
docker-compose up -d
```

Assim que o servidor for iniciado, visite `http://your-ip:3000` para ver o assistente de instalação.

Após a conclusão da instalação, para verificar o ataque, você precisa adicionar um usuário normal na administração com o nome de usuário `vulhub` e o email `vulhub@vulhub.org`.

## Explorando

Há três etapas para reproduzir a vulnerabilidade:

1. Redefina a senha na página de login e o servidor gerará um token de redefinição de senha no banco de dados
2. Use a injeção NoSQL para expor este token de redefinição de senha
3. Use o token de redefinição de senha para alterar a senha do usuário

No passo dois, você pode usar a diretiva `$regex` para realizar o ataque.

No meu cenário, quando `$regex` é igual a `^7`, uma mensagem de erro retornou:

![](3.png)

Quando `$regex` é igual a `^8`, a resposta é diferente. Isso prova que o Token começa com `8`:

![](4.png)

Use este script simples [CVE-2021-22911.py](CVE-2021-22911.py) para exfiltrar o token de redefinição de senha:

![](2.png)

Altere a senha do usuário com sucesso:

![](5.png)
